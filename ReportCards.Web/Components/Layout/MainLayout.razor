@inherits LayoutComponentBase
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<MudThemeProvider Theme="@AppTheme.Theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

    <!-- ─── SIDEBAR ─────────────────────────────────────── -->
    <MudDrawer @bind-Open="_drawerOpen"
               Elevation="0"
               Variant="DrawerVariant.Persistent"
               ClipMode="DrawerClipMode.Never"
               Style="display:flex; flex-direction:column;">

        <!-- Logo -->
        <MudDrawerHeader Class="pa-4" Style="border-bottom: 1px solid rgba(255,255,255,0.08);">
            <div class="d-flex flex-column align-start gap-1">
                <img src="https://www.kinderkollege.ca/images/logo_4.png"
                     alt="KinderKollege"
                     style="height:48px; object-fit:contain; filter:brightness(0) invert(1);" />
                <MudText Typo="Typo.caption" Style="color:rgba(255,255,255,0.45); letter-spacing:0.06em; text-transform:uppercase;">
                    Report Card Builder
                </MudText>
            </div>
        </MudDrawerHeader>

        <!-- Nav (scrollable) -->
        <div style="flex:1; overflow-y:auto;">
        <MudNavMenu Class="px-2 py-3">

            <MudText Typo="Typo.overline" Class="px-3 mb-1" Style="color:rgba(255,255,255,0.35);">
                Admin
            </MudText>
            <MudNavLink Href="/"
                        Match="NavLinkMatch.All"
                        Icon="@Icons.Material.Filled.Dashboard">
                Dashboard
            </MudNavLink>
            <MudNavLink Href="/school-years"
                        Icon="@Icons.Material.Filled.CalendarMonth">
                School Years
            </MudNavLink>
            <MudNavLink Href="/curriculum"
                        Icon="@Icons.Material.Filled.MenuBook">
                Curriculum
            </MudNavLink>
            <MudNavLink Href="/grading-scales"
                        Icon="@Icons.Material.Filled.Scale">
                Grading Scales
            </MudNavLink>

            <MudDivider Class="my-3" Style="border-color:rgba(255,255,255,0.08);" />

            <MudText Typo="Typo.overline" Class="px-3 mb-1" Style="color:rgba(255,255,255,0.35);">
                People
            </MudText>
            <MudNavLink Href="/teachers"
                        Icon="@Icons.Material.Filled.Person">
                Teachers
            </MudNavLink>
            <MudNavLink Href="/students"
                        Icon="@Icons.Material.Filled.School">
                Students
            </MudNavLink>
            <MudNavLink Href="/class-setup"
                        Icon="@Icons.Material.Filled.Groups">
                Class Setup
            </MudNavLink>
            <MudNavLink Href="/enrollments"
                        Icon="@Icons.Material.Filled.EditNote">
                Enrollments
            </MudNavLink>

            <MudDivider Class="my-3" Style="border-color:rgba(255,255,255,0.08);" />

            <MudText Typo="Typo.overline" Class="px-3 mb-1" Style="color:rgba(255,255,255,0.35);">
                Reports
            </MudText>
            <MudNavLink Href="/grade-entry"
                        Icon="@Icons.Material.Filled.Grading">
                Grade Entry
            </MudNavLink>
            <MudNavLink Href="/generate-reports"
                        Icon="@Icons.Material.Filled.Print">
                Generate Reports
            </MudNavLink>

        </MudNavMenu>
        </div>

        <!-- User tile — pinned to bottom -->
        <div style="flex-shrink:0; padding:12px 16px; border-top:1px solid rgba(255,255,255,0.08); background:#1B4F72;">
            @{
                var initials = GetInitials(_userName);
            }
            @if (isLoggedIn)
            {
                <div class="d-flex align-center gap-2">
                    <MudAvatar Style="background:#E67E22; color:white; width:32px; height:32px; font-size:13px; font-weight:700; flex-shrink:0;">
                        @initials
                    </MudAvatar>
                    <div style="flex:1; min-width:0;">
                        <MudText Typo="Typo.body2" Style="color:white; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            @_userName
                        </MudText>
                        <MudText Typo="Typo.caption" Style="color:rgba(255,255,255,0.45); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            @_userEmail
                        </MudText>
                    </div>
                    <MudIconButton Icon="@Icons.Material.Filled.Logout"
                                   Size="Size.Small"
                                   Style="color:rgba(255,255,255,0.45);"
                                   Href="/logout" />
                </div>
            }
            else
            {
                <MudButton Href="/login"
                           Variant="Variant.Outlined"
                           Size="Size.Small"
                           Style="color:white; border-color:rgba(255,255,255,0.3); width:100%;">
                    Sign In
                </MudButton>
            }
        </div>

    </MudDrawer>

    <!-- ─── TOPBAR ─────────────────────────────────────── -->
    <MudAppBar Elevation="1" Dense="false">

        <!-- Hamburger toggle -->
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Default"
                       Edge="Edge.Start"
                       OnClick="ToggleDrawer" />

        <!-- Breadcrumb -->
        <MudBreadcrumbs Items="_breadcrumbs" Class="ml-2" />

        <MudSpacer />

        <!-- Working Year Badge -->
        <MudChip T="string"
                 Icon="@Icons.Material.Filled.CalendarMonth"
                 Color="Color.Primary"
                 Variant="Variant.Outlined"
                 Size="Size.Small"
                 Class="mr-2"
                 Style="font-weight:600;">
            2026–2027
        </MudChip>

        <MudIconButton Icon="@Icons.Material.Filled.Notifications"
                       Color="Color.Default"
                       Size="Size.Medium" />

        <MudIconButton Icon="@Icons.Material.Filled.Settings"
                       Color="Color.Default"
                       Size="Size.Medium" />

    </MudAppBar>

    <!-- ─── MAIN CONTENT ──────────────────────────────── -->
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pa-6">
            @Body
        </MudContainer>
    </MudMainContent>

</MudLayout>


@code {
    private bool _drawerOpen = true;
    private bool isLoggedIn = false;
    private string? _userName;
    private string? _userEmail;

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Admin", href: null, disabled: true),
        new BreadcrumbItem("Dashboard", href: "/", icon: Icons.Material.Filled.Home),
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isLoggedIn = user.Identity?.IsAuthenticated ?? false;
        _userName = user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value;
        _userEmail = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
    }

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpper()
            : parts[0][0].ToString().ToUpper();
    }
}
