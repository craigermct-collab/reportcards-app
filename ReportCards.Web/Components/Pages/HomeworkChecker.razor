@page "/homework-checker"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using ReportCards.Web.Data
@using ReportCards.Web.Services
@implements IDisposable
@inject SchoolDbContext Db
@inject HomeworkAnalysisService AnalysisService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Homework Checker</PageTitle>

<!-- Mobile-first: compact header -->
<div class="d-flex align-center gap-3 mb-4">
    <MudIcon Icon="@Icons.Material.Filled.DocumentScanner"
             Style="background:#1B4F72; color:white; padding:8px; border-radius:10px; font-size:24px;" />
    <div>
        <MudText Typo="Typo.h5" Style="font-family:'DM Serif Display',serif; line-height:1.1;">
            Homework Checker
        </MudText>
        <MudText Typo="Typo.caption" Style="color:var(--mud-palette-text-secondary);">
            AI-powered homework analysis
        </MudText>
    </div>
</div>

@if (_result == null)
{
    <!-- ══ SETUP FORM ══════════════════════════════════════ -->

    <!-- Step 1: Photos -->
    <MudCard Elevation="1" Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <div class="d-flex align-center gap-2">
                    <MudAvatar Style="background:#1B4F72; color:white; width:28px; height:28px; font-size:13px; font-weight:700;">1</MudAvatar>
                    <MudText Typo="Typo.h6">Add Photos</MudText>
                </div>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid Class="mb-4">
                <MudItem xs="6">
                    <label style="display:block; width:100%; cursor:pointer;">
                        <input id="cameraInput" type="file" accept="image/*" capture="environment"
                               multiple style="display:none" />
                        <div style="display:flex; align-items:center; justify-content:center; gap:8px;
                                    height:56px; border-radius:4px; font-size:15px; font-weight:500;
                                    background:#1B4F72; color:white;">
                            <span class="material-icons" style="font-size:20px;">photo_camera</span>
                            Camera
                        </div>
                    </label>
                </MudItem>
                <MudItem xs="6">
                    <label style="display:block; width:100%; cursor:pointer;">
                        <input id="libraryInput" type="file" accept="image/*"
                               multiple style="display:none" />
                        <div style="display:flex; align-items:center; justify-content:center; gap:8px;
                                    height:56px; border-radius:4px; font-size:15px; font-weight:500;
                                    border:1px solid #1B4F72; color:#1B4F72; background:transparent;">
                            <span class="material-icons" style="font-size:20px;">photo_library</span>
                            Library
                        </div>
                    </label>
                </MudItem>
            </MudGrid>

            @if (_thumbnails.Count > 0)
            {
                <!-- Document queue header -->
                <div class="d-flex align-center justify-space-between mb-2">
                    <MudText Typo="Typo.subtitle2">
                        <span class="material-icons" style="font-size:16px; vertical-align:middle; margin-right:4px;">description</span>
                        @_thumbnails.Count page@(_thumbnails.Count == 1 ? "" : "s") queued
                    </MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.DeleteSweep"
                               OnClick="ClearAllImages">Clear all</MudButton>
                </div>

                <!-- Horizontally scrollable page strip -->
                <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:8px;
                            scrollbar-width:thin;">
                    @for (int i = 0; i < _thumbnails.Count; i++)
                    {
                        var idx = i;
                        <div style="position:relative; flex-shrink:0;">
                            <!-- Page thumbnail -->
                            <div style="width:90px; border-radius:8px; overflow:hidden;
                                        border:2px solid #1B4F72; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
                                <img src="@_thumbnails[idx]"
                                     style="width:90px; height:120px; object-fit:cover; display:block;" />
                                <!-- Page number badge -->
                                <div style="background:#1B4F72; color:white; text-align:center;
                                            font-size:11px; font-weight:700; padding:3px 0;">
                                    Page @(idx + 1)
                                </div>
                            </div>
                            <!-- Delete button -->
                            <div style="position:absolute; top:-6px; right:-6px;">
                                <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               Style="background:white; padding:0; width:22px; height:22px; min-width:0;"
                                               OnClick="@(() => RemoveImage(idx))" />
                            </div>
                        </div>
                    }

                    <!-- Add more pages tile -->
                    <div style="flex-shrink:0;">
                        <label style="cursor:pointer; display:block;">
                            <input type="file" accept="image/*" multiple style="display:none" />
                            <div style="width:90px; height:142px; border-radius:8px;
                                        border:2px dashed #1B4F72; display:flex; flex-direction:column;
                                        align-items:center; justify-content:center; gap:4px; color:#1B4F72;">
                                <span class="material-icons" style="font-size:28px;">add_photo_alternate</span>
                                <span style="font-size:11px; font-weight:600; text-align:center; line-height:1.2;">Add more pages</span>
                            </div>
                        </label>
                    </div>
                </div>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                    Tap Camera to photograph homework, or Library to pick existing photos.
                </MudAlert>
            }
        </MudCardContent>
    </MudCard>

    <!-- Step 2: Checks -->
    <MudCard Elevation="1" Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <div class="d-flex align-center gap-2">
                    <MudAvatar Style="background:#1B4F72; color:white; width:28px; height:28px; font-size:13px; font-weight:700;">2</MudAvatar>
                    <MudText Typo="Typo.h6">What to Check</MudText>
                </div>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="6" sm="3">
                    <MudPaper Outlined="true" Class="pa-3 d-flex flex-column align-center"
                              Style="@CheckCardStyle(_checkSpelling)"
                              @onclick="@(() => _checkSpelling = !_checkSpelling)">
                        <MudIcon Icon="@Icons.Material.Filled.Spellcheck"
                                 Style="@CheckIconStyle(_checkSpelling)" />
                        <MudText Typo="Typo.body2" Style="font-weight:600; text-align:center;">Spelling</MudText>
                        <MudText Typo="Typo.caption" Style="@CheckLabelStyle(_checkSpelling)">@CheckLabel(_checkSpelling)</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudPaper Outlined="true" Class="pa-3 d-flex flex-column align-center"
                              Style="@CheckCardStyle(_checkGrammar)"
                              @onclick="@(() => _checkGrammar = !_checkGrammar)">
                        <MudIcon Icon="@Icons.Material.Filled.RateReview"
                                 Style="@CheckIconStyle(_checkGrammar)" />
                        <MudText Typo="Typo.body2" Style="font-weight:600; text-align:center;">Grammar</MudText>
                        <MudText Typo="Typo.caption" Style="@CheckLabelStyle(_checkGrammar)">@CheckLabel(_checkGrammar)</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudPaper Outlined="true" Class="pa-3 d-flex flex-column align-center"
                              Style="@CheckCardStyle(_checkRubric)"
                              @onclick="@(() => _checkRubric = !_checkRubric)">
                        <MudIcon Icon="@Icons.Material.Filled.Checklist"
                                 Style="@CheckIconStyle(_checkRubric)" />
                        <MudText Typo="Typo.body2" Style="font-weight:600; text-align:center;">Rubric</MudText>
                        <MudText Typo="Typo.caption" Style="@CheckLabelStyle(_checkRubric)">@CheckLabel(_checkRubric)</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudPaper Outlined="true" Class="pa-3 d-flex flex-column align-center"
                              Style="@CheckCardStyle(_checkAi)"
                              @onclick="@(() => _checkAi = !_checkAi)">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy"
                                 Style="@CheckIconStyle(_checkAi)" />
                        <MudText Typo="Typo.body2" Style="font-weight:600; text-align:center;">AI Check</MudText>
                        <MudText Typo="Typo.caption" Style="@CheckLabelStyle(_checkAi)">@CheckLabel(_checkAi)</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Step 3: Rubric Context (only shown when Rubric is enabled) -->
    @if (_checkRubric)
    {
        <MudCard Elevation="1" Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <div class="d-flex align-center gap-2">
                        <MudAvatar Style="background:#1B4F72; color:white; width:28px; height:28px; font-size:13px; font-weight:700;">3</MudAvatar>
                        <MudText Typo="Typo.h6">Select Rubric Context</MudText>
                    </div>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="int?" @bind-Value="_selectedClassGroupTypeId"
                                   Label="Class Group" Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var cgt in _classGroupTypes)
                            {
                                <MudSelectItem T="int?" Value="@((int?)cgt.Id)">@cgt.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="int?" @bind-Value="_selectedGradeId"
                                   Label="Grade" Variant="Variant.Outlined"
                                   Disabled="@(_selectedClassGroupTypeId == null)"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var g in GradesForSelectedGroup)
                            {
                                <MudSelectItem T="int?" Value="@((int?)g.Id)">@g.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>
    }

    <!-- Sticky bottom action -->
    <div style="position:sticky; bottom:16px; z-index:10;">
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   StartIcon="@Icons.Material.Filled.AutoAwesome"
                   FullWidth="true"
                   Style="height:56px; font-size:16px; font-weight:700; border-radius:12px; box-shadow: 0 4px 16px rgba(27,79,114,0.4);"
                   OnClick="RunAnalysisAsync"
                   Disabled="@(!CanAnalyze)">
            @if (_analyzing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Analyzing...</span>
            }
            else
            {
                <span>Analyze Homework</span>
            }
        </MudButton>
    </div>
}
else
{
    <!-- ══ RESULTS ════════════════════════════════════════ -->

    <div class="d-flex align-center justify-space-between mb-4">
        <div>
            <MudText Typo="Typo.h6" Style="font-family:'DM Serif Display',serif;">Analysis Results</MudText>
            <MudText Typo="Typo.caption" Style="color:var(--mud-palette-text-secondary);">
                @_result.ClassGroupName • @_result.GradeName • @_result.AnalyzedAt.ToString("MMM d, yyyy h:mm tt")
            </MudText>
        </div>
        <MudTooltip Text="Start new analysis">
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Default"
                           OnClick="@(async () => await Reset())" />
        </MudTooltip>
    </div>

    @if (!_result.Success)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">
            Analysis failed: @_result.ErrorMessage
        </MudAlert>
    }
    else
    {
        <!-- Overall Summary -->
        @if (!string.IsNullOrWhiteSpace(_result.OverallSummary))
        {
            <MudCard Elevation="1" Class="mb-4" Style="border-left: 4px solid #1B4F72;">
                <MudCardContent Class="pa-4">
                    <div class="d-flex gap-3">
                        <MudIcon Icon="@Icons.Material.Filled.Summarize" Color="Color.Primary" />
                        <div>
                            <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);">Overall Summary</MudText>
                            <MudText Typo="Typo.body1">@_result.OverallSummary</MudText>
                        </div>
                    </div>
                </MudCardContent>
            </MudCard>
        }

        <!-- Score cards -->
        <MudGrid Class="mb-4">
            @if (_result.SpellingScore.HasValue)
            {
                <MudItem xs="6" sm="3">
                    @ScoreCard("Spelling", _result.SpellingScore.Value, Icons.Material.Filled.Spellcheck)
                </MudItem>
            }
            @if (_result.GrammarScore.HasValue)
            {
                <MudItem xs="6" sm="3">
                    @ScoreCard("Grammar", _result.GrammarScore.Value, Icons.Material.Filled.RateReview)
                </MudItem>
            }
            @if (_result.RubricScore.HasValue)
            {
                <MudItem xs="6" sm="3">
                    @ScoreCard("Rubric", _result.RubricScore.Value, Icons.Material.Filled.Checklist)
                </MudItem>
            }
            @if (!string.IsNullOrWhiteSpace(_result.AiLikelihood))
            {
                <MudItem xs="6" sm="3">
                    @AiCard(_result.AiLikelihood)
                </MudItem>
            }
        </MudGrid>

        <!-- Detail cards -->
        @if (!string.IsNullOrWhiteSpace(_result.SpellingSummary))
        {
            @DetailCard("Spelling Details", _result.SpellingSummary, Icons.Material.Filled.Spellcheck)
        }
        @if (!string.IsNullOrWhiteSpace(_result.GrammarSummary))
        {
            @DetailCard("Grammar Details", _result.GrammarSummary, Icons.Material.Filled.RateReview)
        }
        @if (!string.IsNullOrWhiteSpace(_result.RubricSummary))
        {
            @DetailCard("Rubric Evaluation", _result.RubricSummary, Icons.Material.Filled.Checklist)
        }
        @if (!string.IsNullOrWhiteSpace(_result.AiDetectionSummary))
        {
            @DetailCard("AI Detection Details", _result.AiDetectionSummary, Icons.Material.Filled.SmartToy)
        }

        <!-- Optional save -->
        @if (!_saved)
        {
            <MudCard Elevation="1" Class="mb-4" Style="border: 2px dashed var(--mud-palette-divider);">
                <MudCardContent Class="pa-4">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Save" Style="font-size:16px; vertical-align:middle; margin-right:4px;" />
                        Save this result for shared review
                    </MudText>
                    <MudTextField @bind-Value="_saveName"
                                  Label="Result name"
                                  Placeholder="e.g. Tommy's Book Report - Feb 23"
                                  Variant="Variant.Outlined"
                                  Class="mb-3" />
                    <MudTextField @bind-Value="_teacherNote"
                                  Label="Teacher note (optional)"
                                  Placeholder="e.g. Strong effort, needs practice with punctuation"
                                  Variant="Variant.Outlined"
                                  Lines="2"
                                  Class="mb-3" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveResultAsync"
                               Disabled="@string.IsNullOrWhiteSpace(_saveName)"
                               FullWidth="true">
                        Save &amp; Share with Team
                    </MudButton>
                </MudCardContent>
            </MudCard>
        }
        else
        {
            <MudAlert Severity="Severity.Success" Class="mb-4" Icon="@Icons.Material.Filled.CheckCircle">
                Saved as "@_saveName" — visible to all teachers.
                <MudLink Href="/saved-analyses" Style="margin-left:8px;">View all saved analyses →</MudLink>
            </MudAlert>
        }
    }

    <!-- Bottom action -->
    <MudButton Variant="Variant.Filled" Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.AddAPhoto"
               FullWidth="true"
               Style="height:56px; font-size:15px; font-weight:700; border-radius:12px;"
               OnClick="@(async () => await Reset())">
        Analyze Another
    </MudButton>
}

@code {
    private List<ClassGroupType> _classGroupTypes = new();
    private int? _selectedClassGroupTypeId;
    private int? _selectedGradeId;

    private SchoolAiConfig? _schoolConfig;
    private TeacherAiConfig? _teacherConfig;

    private bool _checkSpelling = true;
    private bool _checkGrammar = true;
    private bool _checkRubric = true;
    private bool _checkAi = true;

    // Thumbnails for display only (small, 200px) — full images live in JS memory
    private List<string> _thumbnails = new();
    private DotNetObjectReference<HomeworkChecker>? _dotNetRef;
    private bool _analyzing;
    private HomeworkAnalysisResult? _result;
    private string _teacherNote = "";
    private string _saveName = "";
    private bool _saved;

    private bool CanAnalyze =>
        !_analyzing &&
        _thumbnails.Count > 0 &&
        (_checkSpelling || _checkGrammar || _checkRubric || _checkAi) &&
        (!_checkRubric || (_selectedClassGroupTypeId != null && _selectedGradeId != null));

    private List<Grade> GradesForSelectedGroup =>
        _classGroupTypes.FirstOrDefault(c => c.Id == _selectedClassGroupTypeId)
            ?.Grades.OrderBy(g => g.SortOrder).ToList() ?? new();

    protected override async Task OnInitializedAsync()
    {
        _classGroupTypes = await Db.ClassGroupTypes
            .Include(c => c.Grades)
            .OrderBy(c => c.SortOrder)
            .ToListAsync();

        _dotNetRef = DotNetObjectReference.Create(this);
        _schoolConfig = await Db.SchoolAiConfigs.FirstOrDefaultAsync();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
        if (email != null)
        {
            var appUser = await Db.AppUsers
                .Include(u => u.Teacher)
                .FirstOrDefaultAsync(u => u.Email == email);
            if (appUser?.TeacherId != null)
                _teacherConfig = await Db.TeacherAiConfigs
                    .FirstOrDefaultAsync(t => t.TeacherId == appUser.TeacherId);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Re-attach JS listeners every render (handles dynamically added inputs like 'Add more pages')
        if (_dotNetRef != null)
            await JS.InvokeVoidAsync("imageHelper.initFileInputs", _dotNetRef);
    }

    [JSInvokable]
    public void OnImageAdded(int index, string thumbnailDataUrl)
    {
        _thumbnails.Add(thumbnailDataUrl);
        StateHasChanged();
    }

    [JSInvokable]
    public void OnImageError(string fileName, string error)
    {
        Snackbar.Add($"Could not read {fileName}: {error}", Severity.Warning);
        StateHasChanged();
    }

    private async Task RemoveImage(int index)
    {
        if (index >= 0 && index < _thumbnails.Count)
        {
            _thumbnails.RemoveAt(index);
            await JS.InvokeVoidAsync("imageHelper.removeImage", index);
        }
    }

    private async Task ClearAllImages()
    {
        _thumbnails.Clear();
        await JS.InvokeVoidAsync("imageHelper.clearImages");
    }

    private async Task RunAnalysisAsync()
    {
        if (!CanAnalyze) return;
        _analyzing = true;
        StateHasChanged();

        var grade = GradesForSelectedGroup.FirstOrDefault(g => g.Id == _selectedGradeId);
        var classGroup = _classGroupTypes.FirstOrDefault(c => c.Id == _selectedClassGroupTypeId);

        // Fetch full-res images from JS store only at analysis time
        var fullImages = await JS.InvokeAsync<List<string>>("imageHelper.getImages");

        var request = new HomeworkAnalysisRequest
        {
            ImageDataUrls = fullImages,
            GradeName = grade?.Name ?? "",
            ClassGroupName = classGroup?.Name ?? "",
            CheckSpelling = _checkSpelling,
            CheckGrammar = _checkGrammar,
            CheckRubric = _checkRubric,
            CheckAiGenerated = _checkAi,
            SchoolConfig = _schoolConfig,
            TeacherConfig = _teacherConfig
        };

        _result = await AnalysisService.AnalyzeAsync(request);
        _analyzing = false;
        StateHasChanged();
    }

    private async Task SaveResultAsync()
    {
        if (_result == null) return;

        Db.HomeworkAnalyses.Add(new HomeworkAnalysis
        {
            Name = _saveName.Trim(),
            AnalyzedAt = _result.AnalyzedAt,
            GradeName = _result.GradeName,
            ClassGroupName = _result.ClassGroupName,
            CheckedSpelling = _checkSpelling,
            CheckedGrammar = _checkGrammar,
            CheckedRubric = _checkRubric,
            CheckedAiGenerated = _checkAi,
            SpellingScore = _result.SpellingScore,
            SpellingSummary = _result.SpellingSummary,
            GrammarScore = _result.GrammarScore,
            GrammarSummary = _result.GrammarSummary,
            RubricScore = _result.RubricScore,
            RubricSummary = _result.RubricSummary,
            AiLikelihood = _result.AiLikelihood,
            AiDetectionSummary = _result.AiDetectionSummary,
            OverallSummary = _result.OverallSummary,
            TeacherNote = string.IsNullOrWhiteSpace(_teacherNote) ? null : _teacherNote.Trim()
        });

        await Db.SaveChangesAsync();
        _saved = true;
        Snackbar.Add("Result saved.", Severity.Success);
    }

    private async Task Reset()
    {
        _result = null;
        _thumbnails = new();
        _saved = false;
        _teacherNote = "";
        _saveName = "";
        await JS.InvokeVoidAsync("imageHelper.clearImages");
    }

    public void Dispose() => _dotNetRef?.Dispose();

    private static string CheckCardStyle(bool active) =>
        active
            ? "cursor:pointer; border-color:#27AE60; border-width:2px; background:rgba(39,174,96,0.12);"
            : "cursor:pointer; border-color:#ccc; background:#f9f9f9; opacity:0.7;";

    private static string CheckIconStyle(bool active) =>
        active
            ? "font-size:32px; margin-bottom:4px; color:#27AE60;"
            : "font-size:32px; margin-bottom:4px; color:#aaa;";

    private static string CheckLabelStyle(bool active) =>
        active
            ? "font-weight:700; color:#27AE60;"
            : "font-weight:700; color:#aaa;";

    private static string CheckLabel(bool active) => active ? "✓ ON" : "OFF";

    private RenderFragment ScoreCard(string label, int score, string icon)
    {
        var style = ScoreCardStyle(score) + " border-radius:12px; text-align:center;";
        return @<MudCard Elevation="0" Style="@style">
            <MudCardContent Class="pa-3">
                <MudIcon Icon="@icon" Style="font-size:24px; margin-bottom:4px;" />
                <MudText Typo="Typo.h4" Style="font-weight:700; line-height:1;">@score<span style="font-size:14px;">/10</span></MudText>
                <MudText Typo="Typo.caption">@label</MudText>
            </MudCardContent>
        </MudCard>;
    }

    private RenderFragment AiCard(string likelihood)
    {
        var style = AiCardStyle(likelihood) + " border-radius:12px; text-align:center;";
        return @<MudCard Elevation="0" Style="@style">
            <MudCardContent Class="pa-3">
                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Style="font-size:24px; margin-bottom:4px;" />
                <MudText Typo="Typo.h6" Style="font-weight:700; line-height:1.2;">@likelihood</MudText>
                <MudText Typo="Typo.caption">AI Likelihood</MudText>
            </MudCardContent>
        </MudCard>;
    }

    private RenderFragment DetailCard(string title, string content, string icon) =>
        @<MudCard Elevation="1" Class="mb-3">
            <MudCardContent Class="pa-4">
                <div class="d-flex gap-3">
                    <MudIcon Icon="@icon" Color="Color.Primary" Style="margin-top:2px;" />
                    <div>
                        <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);">@title</MudText>
                        <MudText Typo="Typo.body2">@content</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>;

    private string ScoreCardStyle(int score)
    {
        var color = score >= 8 ? "#27AE60" : score >= 5 ? "#E67E22" : "#E74C3C";
        return $"border: 2px solid {color}; background: {color}18; color:{color};";
    }

    private string AiCardStyle(string likelihood) => likelihood switch
    {
        "High" => "border: 2px solid #E74C3C; background: #E74C3C18; color:#E74C3C;",
        "Medium" => "border: 2px solid #E67E22; background: #E67E2218; color:#E67E22;",
        _ => "border: 2px solid #27AE60; background: #27AE6018; color:#27AE60;"
    };
}
