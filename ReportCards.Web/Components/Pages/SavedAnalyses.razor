@page "/saved-analyses"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using ReportCards.Web.Data
@inject SchoolDbContext Db
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Saved Analyses</PageTitle>

<div class="d-flex align-center gap-3 mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Assessment"
             Style="background:#1B4F72; color:white; padding:8px; border-radius:10px; font-size:24px;" />
    <div>
        <MudText Typo="Typo.h5" Style="font-family:'DM Serif Display',serif; line-height:1.1;">Saved Analyses</MudText>
        <MudText Typo="Typo.caption" Style="color:var(--mud-palette-text-secondary);">Shared homework results for your team</MudText>
    </div>
    <MudSpacer />
    <MudButton Variant="Variant.Filled" Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.AddAPhoto"
               Href="/homework-checker">
        New Analysis
    </MudButton>
</div>

<!-- Search + Filter bar -->
<MudPaper Elevation="1" Class="pa-3 mb-4">
    <MudGrid>
        <MudItem xs="12" sm="5">
            <MudTextField @bind-Value="_search" Placeholder="Search by name or note..."
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" />
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudSelect T="string" @bind-Value="_filterClass" Label="Class Group"
                       Variant="Variant.Outlined" Margin="Margin.Dense"
                       AnchorOrigin="Origin.BottomCenter" Clearable="true">
                @foreach (var g in _classGroups)
                {
                    <MudSelectItem T="string" Value="@g">@g</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudSelect T="string" @bind-Value="_filterGrade" Label="Grade"
                       Variant="Variant.Outlined" Margin="Margin.Dense"
                       AnchorOrigin="Origin.BottomCenter" Clearable="true">
                @foreach (var g in _grades)
                {
                    <MudSelectItem T="string" Value="@g">@g</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="1" Class="d-flex align-center">
            <MudText Typo="Typo.caption" Style="color:var(--mud-palette-text-secondary); white-space:nowrap;">
                @Filtered.Count result@(Filtered.Count == 1 ? "" : "s")
            </MudText>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <div class="d-flex justify-center pa-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (!Filtered.Any())
{
    <MudPaper Elevation="0" Class="pa-8 d-flex flex-column align-center"
              Style="border:2px dashed var(--mud-palette-divider); border-radius:12px;">
        <MudIcon Icon="@Icons.Material.Filled.FindInPage"
                 Style="font-size:48px; color:var(--mud-palette-text-disabled); margin-bottom:12px;" />
        <MudText Typo="Typo.h6" Style="color:var(--mud-palette-text-secondary);">No saved analyses found</MudText>
        <MudText Typo="Typo.body2" Style="color:var(--mud-palette-text-disabled);" Class="mb-3">
            @(_allAnalyses.Any() ? "Try adjusting your search or filters" : "Run your first homework analysis to get started")
        </MudText>
        @if (!_allAnalyses.Any())
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.AddAPhoto"
                       Href="/homework-checker">
                Analyze Homework
            </MudButton>
        }
    </MudPaper>
}
else
{
    <MudGrid>
        @foreach (var item in Filtered)
        {
            var capturedItem = item;
            <MudItem xs="12" sm="6" lg="4">
                <MudCard Elevation="2" Style="border-radius:12px; cursor:pointer; transition:box-shadow 0.2s;"
                         @onclick="@(() => OpenDetail(capturedItem))">
                    <div style="height:6px; border-radius:12px 12px 0 0; background:@ScoreColor(capturedItem);" />
                    <MudCardContent Class="pa-4">
                        <div class="d-flex align-start justify-space-between mb-2">
                            <div style="flex:1; min-width:0;">
                                <MudText Typo="Typo.subtitle1"
                                         Style="font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                    @capturedItem.Name
                                </MudText>
                                <MudText Typo="Typo.caption" Style="color:var(--mud-palette-text-secondary);">
                                    @capturedItem.AnalyzedAt.LocalDateTime.ToString("MMM d, yyyy")
                                </MudText>
                            </div>
                            <div @onclick:stopPropagation="true">
                                <MudIconButton Icon="@Icons.Material.Filled.DeleteOutline"
                                               Color="Color.Error" Size="Size.Small"
                                               Style="margin-top:-4px; margin-right:-8px;"
                                               OnClick="@(() => ConfirmDelete(capturedItem))" />
                            </div>
                        </div>

                        <div class="d-flex gap-1 mb-3 flex-wrap">
                            @if (!string.IsNullOrWhiteSpace(capturedItem.ClassGroupName))
                            {
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                                         Color="Color.Primary" Style="height:22px;">
                                    @capturedItem.ClassGroupName
                                </MudChip>
                            }
                            @if (!string.IsNullOrWhiteSpace(capturedItem.GradeName))
                            {
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                                         Color="Color.Secondary" Style="height:22px;">
                                    @capturedItem.GradeName
                                </MudChip>
                            }
                        </div>

                        <div class="d-flex gap-2 flex-wrap mb-3">
                            @if (capturedItem.SpellingScore.HasValue)
                            {
                                <div style="@ScorePill(capturedItem.SpellingScore.Value)">
                                    <span class="material-icons" style="font-size:12px;">spellcheck</span>
                                    @capturedItem.SpellingScore/10
                                </div>
                            }
                            @if (capturedItem.GrammarScore.HasValue)
                            {
                                <div style="@ScorePill(capturedItem.GrammarScore.Value)">
                                    <span class="material-icons" style="font-size:12px;">rate_review</span>
                                    @capturedItem.GrammarScore/10
                                </div>
                            }
                            @if (capturedItem.RubricScore.HasValue)
                            {
                                <div style="@ScorePill(capturedItem.RubricScore.Value)">
                                    <span class="material-icons" style="font-size:12px;">checklist</span>
                                    @capturedItem.RubricScore/10
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(capturedItem.AiLikelihood))
                            {
                                <div style="@AiPill(capturedItem.AiLikelihood)">
                                    <span class="material-icons" style="font-size:12px;">smart_toy</span>
                                    AI: @capturedItem.AiLikelihood
                                </div>
                            }
                        </div>

                        @if (!string.IsNullOrWhiteSpace(capturedItem.OverallSummary))
                        {
                            <MudText Typo="Typo.body2"
                                     Style="color:var(--mud-palette-text-secondary); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">
                                @capturedItem.OverallSummary
                            </MudText>
                        }

                        @if (!string.IsNullOrWhiteSpace(capturedItem.TeacherNote))
                        {
                            <div class="mt-2 d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Filled.StickyNote2"
                                         Style="font-size:14px; color:#F39C12;" />
                                <MudText Typo="Typo.caption" Style="color:#F39C12; font-style:italic;
                                         overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                    @capturedItem.TeacherNote
                                </MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

<!-- Detail Drawer -->
<MudDrawer @bind-Open="_drawerOpen" Anchor="Anchor.Right" Elevation="4"
           Variant="DrawerVariant.Temporary" OverlayAutoClose="true"
           Width="420px">
    @if (_selected != null)
    {
        <MudDrawerHeader Style="background:#1B4F72; padding:16px 20px;">
            <div style="flex:1; min-width:0;">
                <MudText Typo="Typo.h6" Style="color:white; font-family:'DM Serif Display',serif;
                         overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    @_selected.Name
                </MudText>
                <MudText Typo="Typo.caption" Style="color:rgba(255,255,255,0.7);">
                    @_selected.ClassGroupName • @_selected.GradeName •
                    @_selected.AnalyzedAt.LocalDateTime.ToString("MMM d, yyyy h:mm tt")
                </MudText>
            </div>
            <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit"
                           OnClick="@(() => _drawerOpen = false)" />
        </MudDrawerHeader>

        <MudDrawerContainer Style="overflow-y:auto; padding:16px;">

            <div class="d-flex gap-1 flex-wrap mb-4">
                @CheckBadge("Spelling",  _selected.CheckedSpelling)
                @CheckBadge("Grammar",   _selected.CheckedGrammar)
                @CheckBadge("Rubric",    _selected.CheckedRubric)
                @CheckBadge("AI Check",  _selected.CheckedAiGenerated)
            </div>

            @if (!string.IsNullOrWhiteSpace(_selected.OverallSummary))
            {
                <MudCard Elevation="0" Class="mb-3" Style="border-left:4px solid #1B4F72; background:#f8f9fa;">
                    <MudCardContent Class="pa-3">
                        <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);">Overall Summary</MudText>
                        <MudText Typo="Typo.body2">@_selected.OverallSummary</MudText>
                    </MudCardContent>
                </MudCard>
            }

            <MudGrid Class="mb-3">
                @if (_selected.SpellingScore.HasValue)
                {
                    <MudItem xs="6">@DrawerScoreCard("Spelling", _selected.SpellingScore.Value, Icons.Material.Filled.Spellcheck)</MudItem>
                }
                @if (_selected.GrammarScore.HasValue)
                {
                    <MudItem xs="6">@DrawerScoreCard("Grammar", _selected.GrammarScore.Value, Icons.Material.Filled.RateReview)</MudItem>
                }
                @if (_selected.RubricScore.HasValue)
                {
                    <MudItem xs="6">@DrawerScoreCard("Rubric", _selected.RubricScore.Value, Icons.Material.Filled.Checklist)</MudItem>
                }
                @if (!string.IsNullOrWhiteSpace(_selected.AiLikelihood))
                {
                    <MudItem xs="6">@DrawerAiCard(_selected.AiLikelihood)</MudItem>
                }
            </MudGrid>

            @if (!string.IsNullOrWhiteSpace(_selected.SpellingSummary))
            { @DrawerDetail("Spelling Details",     _selected.SpellingSummary,    Icons.Material.Filled.Spellcheck) }
            @if (!string.IsNullOrWhiteSpace(_selected.GrammarSummary))
            { @DrawerDetail("Grammar Details",      _selected.GrammarSummary,     Icons.Material.Filled.RateReview)  }
            @if (!string.IsNullOrWhiteSpace(_selected.RubricSummary))
            { @DrawerDetail("Rubric Evaluation",    _selected.RubricSummary,      Icons.Material.Filled.Checklist)   }
            @if (!string.IsNullOrWhiteSpace(_selected.AiDetectionSummary))
            { @DrawerDetail("AI Detection",         _selected.AiDetectionSummary, Icons.Material.Filled.SmartToy)    }

            @if (!string.IsNullOrWhiteSpace(_selected.TeacherNote))
            {
                <MudCard Elevation="0" Class="mb-3"
                         Style="border:1px solid #F39C12; background:#FFFBF2; border-radius:8px;">
                    <MudCardContent Class="pa-3">
                        <div class="d-flex align-center gap-2 mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.StickyNote2"
                                     Style="font-size:16px; color:#F39C12;" />
                            <MudText Typo="Typo.overline" Style="color:#F39C12;">Teacher Note</MudText>
                        </div>
                        <MudText Typo="Typo.body2" Style="font-style:italic;">@_selected.TeacherNote</MudText>
                    </MudCardContent>
                </MudCard>
            }

            <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true"
                       StartIcon="@Icons.Material.Filled.Delete"
                       OnClick="@(() => ConfirmDelete(_selected))" Class="mt-2">
                Delete This Analysis
            </MudButton>

        </MudDrawerContainer>
    }
</MudDrawer>

@code {
    private List<HomeworkAnalysis> _allAnalyses = new();
    private bool _loading = true;
    private string _search = "";
    private string? _filterClass;
    private string? _filterGrade;
    private bool _drawerOpen;
    private HomeworkAnalysis? _selected;

    private List<string> _classGroups = new();
    private List<string> _grades = new();

    private List<HomeworkAnalysis> Filtered => _allAnalyses
        .Where(a =>
            (string.IsNullOrWhiteSpace(_search) ||
             (a.Name?.Contains(_search, StringComparison.OrdinalIgnoreCase) == true) ||
             (a.TeacherNote?.Contains(_search, StringComparison.OrdinalIgnoreCase) == true) ||
             (a.OverallSummary?.Contains(_search, StringComparison.OrdinalIgnoreCase) == true))
            && (string.IsNullOrWhiteSpace(_filterClass) || a.ClassGroupName == _filterClass)
            && (string.IsNullOrWhiteSpace(_filterGrade) || a.GradeName == _filterGrade))
        .OrderByDescending(a => a.AnalyzedAt)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _allAnalyses = await Db.HomeworkAnalyses
            .OrderByDescending(a => a.AnalyzedAt)
            .ToListAsync();

        _classGroups = _allAnalyses
            .Where(a => !string.IsNullOrWhiteSpace(a.ClassGroupName))
            .Select(a => a.ClassGroupName!)
            .Distinct().OrderBy(x => x).ToList();

        _grades = _allAnalyses
            .Where(a => !string.IsNullOrWhiteSpace(a.GradeName))
            .Select(a => a.GradeName!)
            .Distinct().OrderBy(x => x).ToList();

        _loading = false;
    }

    private void OpenDetail(HomeworkAnalysis item)
    {
        _selected = item;
        _drawerOpen = true;
    }

    private async Task ConfirmDelete(HomeworkAnalysis item)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Analysis",
            $"Delete \"{item.Name}\"? This cannot be undone.",
            yesText: "Delete", noText: "Cancel");

        if (result == true)
            await DeleteAsync(item);
    }

    private async Task DeleteAsync(HomeworkAnalysis item)
    {
        Db.HomeworkAnalyses.Remove(item);
        await Db.SaveChangesAsync();
        _allAnalyses.Remove(item);
        if (_selected?.Id == item.Id)
        {
            _drawerOpen = false;
            _selected = null;
        }
        Snackbar.Add("Analysis deleted.", Severity.Success);
    }

    private static string ScoreColor(HomeworkAnalysis a)
    {
        var scores = new[] { a.SpellingScore, a.GrammarScore, a.RubricScore }
            .Where(s => s.HasValue).Select(s => s!.Value).ToList();
        if (!scores.Any()) return "#95A5A6";
        var avg = scores.Average();
        return avg >= 8 ? "#27AE60" : avg >= 5 ? "#E67E22" : "#E74C3C";
    }

    private static string ScorePill(int score)
    {
        var c = score >= 8 ? "#27AE60" : score >= 5 ? "#E67E22" : "#E74C3C";
        return $"display:inline-flex; align-items:center; gap:3px; padding:2px 8px; border-radius:20px; " +
               $"font-size:11px; font-weight:700; background:{c}18; color:{c}; border:1px solid {c}44;";
    }

    private static string AiPill(string likelihood)
    {
        var c = likelihood == "High" ? "#E74C3C" : likelihood == "Medium" ? "#E67E22" : "#27AE60";
        return $"display:inline-flex; align-items:center; gap:3px; padding:2px 8px; border-radius:20px; " +
               $"font-size:11px; font-weight:700; background:{c}18; color:{c}; border:1px solid {c}44;";
    }

    private static string CheckBadgeStyle(bool active) =>
        active ? "height:22px;" : "height:22px; opacity:0.4;";

    private RenderFragment CheckBadge(string label, bool active) =>
        @<MudChip T="string" Size="Size.Small"
                  Color="@(active ? Color.Success : Color.Default)"
                  Variant="@(active ? Variant.Filled : Variant.Outlined)"
                  Style="@CheckBadgeStyle(active)">
            @label
        </MudChip>;

    private RenderFragment DrawerScoreCard(string label, int score, string icon)
    {
        var c = score >= 8 ? "#27AE60" : score >= 5 ? "#E67E22" : "#E74C3C";
        return @<MudCard Elevation="0"
                         Style="@($"border:2px solid {c}; background:{c}18; color:{c}; border-radius:10px; text-align:center;")">
            <MudCardContent Class="pa-2">
                <MudIcon Icon="@icon" Style="font-size:20px; margin-bottom:2px;" />
                <MudText Typo="Typo.h5" Style="font-weight:700; line-height:1;">
                    @score<span style="font-size:12px;">/10</span>
                </MudText>
                <MudText Typo="Typo.caption">@label</MudText>
            </MudCardContent>
        </MudCard>;
    }

    private RenderFragment DrawerAiCard(string likelihood)
    {
        var c = likelihood == "High" ? "#E74C3C" : likelihood == "Medium" ? "#E67E22" : "#27AE60";
        return @<MudCard Elevation="0"
                         Style="@($"border:2px solid {c}; background:{c}18; color:{c}; border-radius:10px; text-align:center;")">
            <MudCardContent Class="pa-2">
                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Style="font-size:20px; margin-bottom:2px;" />
                <MudText Typo="Typo.h6" Style="font-weight:700; line-height:1.2;">@likelihood</MudText>
                <MudText Typo="Typo.caption">AI Likelihood</MudText>
            </MudCardContent>
        </MudCard>;
    }

    private RenderFragment DrawerDetail(string title, string content, string icon) =>
        @<MudCard Elevation="0" Class="mb-3"
                  Style="border:1px solid var(--mud-palette-divider); border-radius:8px;">
            <MudCardContent Class="pa-3">
                <div class="d-flex gap-2 mb-1">
                    <MudIcon Icon="@icon" Color="Color.Primary" Style="font-size:16px; margin-top:2px;" />
                    <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);">@title</MudText>
                </div>
                <MudText Typo="Typo.body2">@content</MudText>
            </MudCardContent>
        </MudCard>;
}
