@page "/teachers"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using ReportCards.Web.Data
@using System.Text.Json
@inject SchoolDbContext Db
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<div class="d-flex align-center gap-3 mb-1">
    <MudText Typo="Typo.h4" Style="font-family:'DM Serif Display',serif;">Teachers</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
               StartIcon="@Icons.Material.Filled.PersonAdd"
               OnClick="OpenNew">
        New Teacher
    </MudButton>
</div>
<MudText Typo="Typo.body2" Class="mb-6" Style="color:var(--mud-palette-text-secondary);">
    Manage teacher profiles and active status.
</MudText>

@if (_error != null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
}

<MudCard Elevation="1">
    <MudCardContent Class="pa-0">
        @if (_teachers.Count == 0)
        {
            <div class="pa-6">
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">No teachers yet. Click "New Teacher" to add one.</MudAlert>
            </div>
        }
        else
        {
            <MudTable Items="_teachers" Hover="true" Dense="false" Elevation="0">
                <HeaderContent>
                    <MudTh>Teacher</MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh>Title</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh Style="text-align:right;">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <div class="d-flex align-center gap-2">
                            <div style="width:40px; height:40px; border-radius:50%; overflow:hidden; flex-shrink:0; background:#e8f0fe; cursor:pointer;"
                                 @onclick="@(() => OpenEdit(context))">
                                <img src="@AvatarUrl(context.AvatarConfigJson, context.DisplayName)" style="width:40px; height:40px;" alt="avatar" />
                            </div>
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight:600;">@context.DisplayName</MudText>
                                @if (!string.IsNullOrWhiteSpace(context.Phone))
                                {
                                    <MudText Typo="Typo.caption" Style="color:var(--mud-palette-text-secondary);">@context.Phone</MudText>
                                }
                            </div>
                        </div>
                    </MudTd>
                    <MudTd>@context.Email</MudTd>
                    <MudTd>
                        @if (!string.IsNullOrWhiteSpace(context.Title))
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">@context.Title</MudChip>
                        }
                        else { <span style="color:var(--mud-palette-text-disabled);">â€”</span> }
                    </MudTd>
                    <MudTd>
                        @if (context.IsActive)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">Active</MudChip>
                        }
                        else
                        {
                            <MudTooltip Text="@($"Inactivated: {context.InactivatedReason}")">
                                <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Filled">Inactive</MudChip>
                            </MudTooltip>
                        }
                    </MudTd>
                    <MudTd Style="text-align:right;">
                        <MudTooltip Text="Edit profile">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                                           OnClick="@(() => OpenEdit(context))" />
                        </MudTooltip>
                        @if (context.IsActive)
                        {
                            <MudTooltip Text="Deactivate">
                                <MudIconButton Icon="@Icons.Material.Filled.PersonOff" Color="Color.Warning" Size="Size.Small"
                                               OnClick="@(() => DeactivateAsync(context))" />
                            </MudTooltip>
                        }
                        else
                        {
                            <MudTooltip Text="Reactivate">
                                <MudIconButton Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Success" Size="Size.Small"
                                               OnClick="@(() => ReactivateAsync(context))" />
                            </MudTooltip>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudCardContent>
</MudCard>

<MudDrawer @bind-Open="_drawerOpen" Anchor="Anchor.Right" Elevation="4"
           Variant="DrawerVariant.Temporary" OverlayAutoClose="true" Width="440px">
    <MudDrawerHeader Style="background:#1B4F72; padding:16px 20px;">
        <div class="d-flex align-center gap-3" style="flex:1; min-width:0;">
            <div style="width:48px; height:48px; border-radius:50%; overflow:hidden; flex-shrink:0; background:white;">
                <img src="@AvatarUrl(_editAvatarJson, string.IsNullOrWhiteSpace(_editName) ? "new" : _editName)" style="width:48px; height:48px;" alt="avatar" />
            </div>
            <div style="min-width:0;">
                <MudText Typo="Typo.h6" Style="color:white; font-family:'DM Serif Display',serif; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    @(string.IsNullOrWhiteSpace(_editName) ? "New Teacher" : _editName)
                </MudText>
                <MudText Typo="Typo.caption" Style="color:rgba(255,255,255,0.6);">
                    @(_isNew ? "Create Profile" : "Edit Profile")
                </MudText>
            </div>
        </div>
        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" OnClick="@(() => _drawerOpen = false)" />
    </MudDrawerHeader>

    <MudDrawerContainer Style="overflow-y:auto; padding:20px;">

        <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);" Class="mb-2">Contact</MudText>
        <MudTextField @bind-Value="_editName"  Label="Display Name" Placeholder="e.g. Ms. Johnson" Variant="Variant.Outlined" Class="mb-3" />
        <MudTextField @bind-Value="_editTitle" Label="Title / Role" Placeholder="e.g. Lead Teacher, EA, Supply" Variant="Variant.Outlined" Class="mb-3" />
        <MudTextField @bind-Value="_editEmail" Label="Email" Placeholder="e.g. johnson@school.ca" Variant="Variant.Outlined" InputType="InputType.Email" Class="mb-3" />
        <MudTextField @bind-Value="_editPhone" Label="Phone" Variant="Variant.Outlined" InputType="InputType.Telephone" Class="mb-4" />

        <MudDivider Class="mb-4" />

        <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);" Class="mb-2">Dates</MudText>
        <MudDatePicker @bind-Date="_editHireDate" Label="Hire Date" Variant="Variant.Outlined"
                       DateFormat="yyyy-MM-dd" Class="mb-3" />
        <MudDatePicker @bind-Date="_editTerminationDate" Label="Termination Date" Variant="Variant.Outlined"
                       DateFormat="yyyy-MM-dd" Class="mb-4" />

        <MudDivider Class="mb-4" />

        <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);" Class="mb-2">Notes</MudText>
        <MudTextField @bind-Value="_editNotes" Label="Notes" Placeholder="e.g. certifications, leave dates, other notes"
                      Variant="Variant.Outlined" Lines="3" MaxLength="300" Class="mb-4" />

        <MudDivider Class="mb-4" />

        <MudText Typo="Typo.overline" Style="color:var(--mud-palette-text-secondary);" Class="mb-3">Avatar</MudText>

        <div class="d-flex justify-center mb-4">
            <div style="width:120px; height:120px; border-radius:50%; overflow:hidden; border:4px solid #1B4F72; background:#e8f0fe;">
                <img src="@AvatarUrl(_editAvatarJson, string.IsNullOrWhiteSpace(_editName) ? "new" : _editName)" style="width:120px; height:120px;" />
            </div>
        </div>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Skin Tone</MudText>
        <div class="d-flex gap-2 flex-wrap mb-3">
            @foreach (var (label, val) in _skinOptions)
            {
                var v = val;
                var swatchStyle = $"width:32px; height:32px; border-radius:50%; cursor:pointer; background:#{SkinHex(v)}; border:{(GetAvatarProp("skinColor") == v ? "3px solid #1B4F72" : "2px solid #ccc")}";
                <div @onclick="@(() => SetAvatarProp("skinColor", v))"
                     style="@swatchStyle"
                     title="@label" />
            }
        </div>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Hair Style</MudText>
        <MudSelect T="string" Value="@GetAvatarProp("top")" ValueChanged="@(v => SetAvatarProp("top", v))"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" AnchorOrigin="Origin.BottomCenter">
            @foreach (var (label, val) in _hairOptions)
            {
                <MudSelectItem T="string" Value="@val">@label</MudSelectItem>
            }
        </MudSelect>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Hair Colour</MudText>
        <div class="d-flex gap-2 flex-wrap mb-3">
            @foreach (var (label, val) in _hairColourOptions)
            {
                var v = val;
                <div @onclick="@(() => SetAvatarProp("hairColor", v))"
                     style="width:28px; height:28px; border-radius:50%; cursor:pointer; background:#@v;
                            border:@(GetAvatarProp("hairColor") == v ? "3px solid #1B4F72" : "2px solid #ccc");"
                     title="@label" />
            }
        </div>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Eyes</MudText>
        <MudSelect T="string" Value="@GetAvatarProp("eyes")" ValueChanged="@(v => SetAvatarProp("eyes", v))"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" AnchorOrigin="Origin.BottomCenter">
            @foreach (var (label, val) in _eyeOptions)
            {
                <MudSelectItem T="string" Value="@val">@label</MudSelectItem>
            }
        </MudSelect>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Mouth</MudText>
        <MudSelect T="string" Value="@GetAvatarProp("mouth")" ValueChanged="@(v => SetAvatarProp("mouth", v))"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" AnchorOrigin="Origin.BottomCenter">
            @foreach (var (label, val) in _mouthOptions)
            {
                <MudSelectItem T="string" Value="@val">@label</MudSelectItem>
            }
        </MudSelect>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Clothing</MudText>
        <MudSelect T="string" Value="@GetAvatarProp("clothing")" ValueChanged="@(v => SetAvatarProp("clothing", v))"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" AnchorOrigin="Origin.BottomCenter">
            @foreach (var (label, val) in _clothingOptions)
            {
                <MudSelectItem T="string" Value="@val">@label</MudSelectItem>
            }
        </MudSelect>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Accessories</MudText>
        <MudSelect T="string" Value="@GetAvatarProp("accessories")" ValueChanged="@(v => SetAvatarProp("accessories", v))"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" AnchorOrigin="Origin.BottomCenter">
            @foreach (var (label, val) in _accessoryOptions)
            {
                <MudSelectItem T="string" Value="@val">@label</MudSelectItem>
            }
        </MudSelect>

        <MudText Typo="Typo.caption" Style="font-weight:600;" Class="mb-1">Background</MudText>
        <div class="d-flex gap-2 flex-wrap mb-4">
            @foreach (var (label, val) in _bgOptions)
            {
                var v = val;
                <div @onclick="@(() => SetAvatarProp("backgroundColor", v))"
                     style="width:28px; height:28px; border-radius:6px; cursor:pointer; background:#@v;
                            border:@(GetAvatarProp("backgroundColor") == v ? "3px solid #1B4F72" : "2px solid #ccc");"
                     title="@label" />
            }
        </div>

        <MudDivider Class="mb-4" />

        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                   StartIcon="@(_isNew ? Icons.Material.Filled.PersonAdd : Icons.Material.Filled.Save)"
                   OnClick="SaveAsync" Class="mb-2">
            @(_isNew ? "Create Teacher" : "Save Changes")
        </MudButton>
        <MudButton Variant="Variant.Text" FullWidth="true" OnClick="@(() => _drawerOpen = false)">
            Cancel
        </MudButton>

    </MudDrawerContainer>
</MudDrawer>

@code {
    private List<Teacher> _teachers = new();
    private string? _error;

    private bool      _drawerOpen;
    private bool      _isNew;
    private Teacher?  _editing;
    private string    _editName            = "";
    private string    _editEmail           = "";
    private string    _editPhone           = "";
    private string    _editTitle           = "";
    private DateTime? _editHireDate;
    private DateTime? _editTerminationDate;
    private string    _editNotes           = "";
    private string?   _editAvatarJson;

    private static readonly (string Label, string Val)[] _skinOptions =
    [
        ("Light",      "ffdbb4"),
        ("Pale",       "f8d25c"),
        ("Tanned",     "fd9841"),
        ("Warm",       "edb98a"),
        ("Brown",      "d08b5b"),
        ("Dark Brown", "ae5d29"),
        ("Black",      "614335"),
    ];

    private static readonly (string Label, string Val)[] _hairOptions =
    [
        ("Short Flat",        "shortFlat"),
        ("Short Curly",       "shortCurly"),
        ("Short Round",       "shortRound"),
        ("Short Waved",       "shortWaved"),
        ("Sides",             "sides"),
        ("The Caesar",        "theCaesar"),
        ("Shaved Sides",      "shavedSides"),
        ("Dreads",            "dreads"),
        ("Dreads Alt",        "dreads01"),
        ("Bob",               "bob"),
        ("Bun",               "bun"),
        ("Curly",             "curly"),
        ("Curvy",             "curvy"),
        ("Big Hair",          "bigHair"),
        ("Long Straight",     "straight01"),
        ("Long Straight Alt", "straight02"),
        ("Frida",             "frida"),
        ("Fro",               "fro"),
        ("Fro Band",          "froBand"),
        ("Mia Wallace",       "miaWallace"),
        ("Shaggy",            "shaggy"),
        ("Hat",               "hat"),
        ("Hijab",             "hijab"),
        ("Turban",            "turban"),
        ("Winter Hat",        "winterHat1"),
    ];

    private static readonly (string Label, string Val)[] _hairColourOptions =
    [
        ("Black","2c1b18"),("Dark Brown","4a312c"),("Brown","724133"),("Blonde","b58143"),
        ("Golden","d6b370"),("Platinum","f59797"),("Red","c93305"),("Auburn","a55728"),
        ("Silver","ecdcbf"),("Pastel Pink","ff488e"),
    ];

    private static readonly (string Label, string Val)[] _eyeOptions =
    [
        ("Default","default"),("Happy","happy"),("Wink","wink"),("Hearts","hearts"),
        ("Side","side"),("Squint","squint"),("Surprised","surprised"),("Closed","closed"),
        ("Cry","cry"),("Roll","eyeRoll"),("X Dizzy","xDizzy"),
    ];

    private static readonly (string Label, string Val)[] _mouthOptions =
    [
        ("Smile","smile"),("Default","default"),("Twinkle","twinkle"),("Tongue","tongue"),
        ("Serious","serious"),("Sad","sad"),("Scream","screamOpen"),("Eating","eating"),
        ("Disbelief","disbelief"),("Grimace","grimace"),
    ];

    private static readonly (string Label, string Val)[] _clothingOptions =
    [
        ("Blazer & Shirt","blazerAndShirt"),("Blazer & Sweater","blazerAndSweater"),
        ("Collar & Sweater","collarAndSweater"),("Hoodie","hoodie"),
        ("Graphic Shirt","graphicShirt"),("Overall","overall"),
        ("Crew Neck","shirtCrewNeck"),("Scoop Neck","shirtScoopNeck"),("V Neck","shirtVNeck"),
    ];

    private static readonly (string Label, string Val)[] _accessoryOptions =
    [
        ("None",""),("Round Glasses","round"),("Sunglasses","sunglasses"),
        ("Prescription 1","prescription01"),("Prescription 2","prescription02"),
        ("Kurt","kurt"),("Wayfarers","wayfarers"),("Eyepatch","eyepatch"),
    ];

    private static readonly (string Label, string Val)[] _bgOptions =
    [
        ("Sky Blue","b6e3f4"),("Lavender","c0aede"),("Periwinkle","d1d4f9"),
        ("Pink","ffd5dc"),("Peach","ffdfbf"),("Mint","a7ffc4"),
        ("Navy","1B4F72"),("White","ffffff"),
    ];

    private static string SkinHex(string val) => string.IsNullOrEmpty(val) ? "ffdbb4" : val;

    private static string AvatarUrl(string? json, string? name)
    {
        var props = ParseAvatar(json);
        var sb = new System.Text.StringBuilder("https://api.dicebear.com/9.x/avataaars/svg?");
        sb.Append("seed=").Append(Uri.EscapeDataString(name ?? "teacher"));
        if (props.TryGetValue("skinColor",       out var skin))  sb.Append("&skinColor=").Append(skin);
        if (props.TryGetValue("top",             out var top))   sb.Append("&top=").Append(top);
        if (props.TryGetValue("hairColor",       out var hc))    sb.Append("&hairColor=").Append(hc);
        if (props.TryGetValue("eyes",            out var eyes))  sb.Append("&eyes=").Append(eyes);
        if (props.TryGetValue("mouth",           out var mouth)) sb.Append("&mouth=").Append(mouth);
        if (props.TryGetValue("clothing",        out var cloth)) sb.Append("&clothing=").Append(cloth);
        if (props.TryGetValue("accessories",     out var acc) && !string.IsNullOrEmpty(acc))
            sb.Append("&accessories=").Append(acc).Append("&accessoriesProbability=100");
        else
            sb.Append("&accessoriesProbability=0");
        if (props.TryGetValue("backgroundColor", out var bg))   sb.Append("&backgroundColor=").Append(bg);
        sb.Append("&backgroundType=solid&radius=50&scale=90");
        return sb.ToString();
    }

    private static Dictionary<string, string> ParseAvatar(string? json)
    {
        if (string.IsNullOrWhiteSpace(json)) return new();
        try { return JsonSerializer.Deserialize<Dictionary<string, string>>(json) ?? new(); }
        catch { return new(); }
    }

    private string GetAvatarProp(string key)
    {
        var props = ParseAvatar(_editAvatarJson);
        return props.TryGetValue(key, out var v) ? v : "";
    }

    private void SetAvatarProp(string key, string value)
    {
        var props = ParseAvatar(_editAvatarJson);
        props[key] = value;
        _editAvatarJson = JsonSerializer.Serialize(props);
    }

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        try { _teachers = await Db.Teachers.OrderBy(t => t.DisplayName).ToListAsync(); }
        catch (Exception ex) { _error = ex.Message; }
    }

    private void OpenNew()
    {
        _isNew               = true;
        _editing             = null;
        _editName            = "";
        _editEmail           = "";
        _editPhone           = "";
        _editTitle           = "";
        _editHireDate        = null;
        _editTerminationDate = null;
        _editNotes           = "";
        _editAvatarJson      = null;
        _drawerOpen          = true;
    }

    private void OpenEdit(Teacher t)
    {
        _isNew               = false;
        _editing             = t;
        _editName            = t.DisplayName;
        _editEmail           = t.Email;
        _editPhone           = t.Phone ?? "";
        _editTitle           = t.Title ?? "";
        _editHireDate        = t.HireDate.HasValue ? t.HireDate.Value.ToDateTime(TimeOnly.MinValue) : null;
        _editTerminationDate = t.TerminationDate.HasValue ? t.TerminationDate.Value.ToDateTime(TimeOnly.MinValue) : null;
        _editNotes           = t.Notes ?? "";
        _editAvatarJson      = t.AvatarConfigJson;
        _drawerOpen          = true;
    }

    private async Task SaveAsync()
    {
        if (string.IsNullOrWhiteSpace(_editName) || string.IsNullOrWhiteSpace(_editEmail))
        { Snackbar.Add("Name and email are required.", Severity.Warning); return; }

        var email = _editEmail.Trim().ToLower();

        if (_isNew)
        {
            if (await Db.Teachers.AnyAsync(t => t.Email == email))
            { Snackbar.Add("A teacher with that email already exists.", Severity.Warning); return; }

            Db.Teachers.Add(new Teacher
            {
                DisplayName     = _editName.Trim(),
                Email           = email,
                Phone           = string.IsNullOrWhiteSpace(_editPhone) ? null : _editPhone.Trim(),
                Title           = string.IsNullOrWhiteSpace(_editTitle) ? null : _editTitle.Trim(),
                HireDate        = _editHireDate.HasValue ? DateOnly.FromDateTime(_editHireDate.Value) : null,
                TerminationDate = _editTerminationDate.HasValue ? DateOnly.FromDateTime(_editTerminationDate.Value) : null,
                Notes           = string.IsNullOrWhiteSpace(_editNotes) ? null : _editNotes.Trim(),
                AvatarConfigJson = _editAvatarJson,
                IsActive        = true
            });
            await Db.SaveChangesAsync();
            _drawerOpen = false;
            Snackbar.Add("Teacher created.", Severity.Success);
        }
        else
        {
            if (_editing == null) return;
            if (await Db.Teachers.AnyAsync(t => t.Email == email && t.Id != _editing.Id))
            { Snackbar.Add("That email is already used by another teacher.", Severity.Warning); return; }

            _editing.DisplayName     = _editName.Trim();
            _editing.Email           = email;
            _editing.Phone           = string.IsNullOrWhiteSpace(_editPhone) ? null : _editPhone.Trim();
            _editing.Title           = string.IsNullOrWhiteSpace(_editTitle) ? null : _editTitle.Trim();
            _editing.HireDate        = _editHireDate.HasValue ? DateOnly.FromDateTime(_editHireDate.Value) : null;
            _editing.TerminationDate = _editTerminationDate.HasValue ? DateOnly.FromDateTime(_editTerminationDate.Value) : null;
            _editing.Notes           = string.IsNullOrWhiteSpace(_editNotes) ? null : _editNotes.Trim();
            _editing.AvatarConfigJson = _editAvatarJson;
            await Db.SaveChangesAsync();
            _drawerOpen = false;
            Snackbar.Add("Profile saved.", Severity.Success);
        }

        await LoadAsync();
    }

    private async Task DeactivateAsync(Teacher t)
    {
        t.IsActive = false; t.InactivatedOn = DateTimeOffset.UtcNow; t.InactivatedReason = "Manually deactivated";
        await Db.SaveChangesAsync();
        Snackbar.Add($"{t.DisplayName} deactivated.", Severity.Info);
        await LoadAsync();
    }

    private async Task ReactivateAsync(Teacher t)
    {
        t.IsActive = true; t.InactivatedOn = null; t.InactivatedReason = null;
        await Db.SaveChangesAsync();
        Snackbar.Add($"{t.DisplayName} reactivated.", Severity.Success);
        await LoadAsync();
    }
}
